---
title: "CRP"
author: "Tea Heikkil√§, Emilia Kaiser & Jaakko Koskenniemi"
output: html_document
date: '2022-24-04'
editor_options:
  chunk_output_type: console
---

Load packages and import data
```{r}
library(tidyverse)
library(data.table)
library(coloc)
library(TwoSampleMR)
library(ggpubr)
library(ieugwasr)
library(rio)
library(here)

here::i_am("analyses/IL6R.Rmd")


IL6R_crp <- read_exposure_data("data/export/IL6R_crp_TwoSampleMR.csv", sep=",")
IL6R_T1D  <- read_outcome_data("data/export/IL6R_T1D_TwoSampleMR.csv", sep=",")

IL6R <- harmonise_data(IL6R_crp, IL6R_T1D)

```

## Manhattan plots
```{r}
#create Manhattan plots with vertical lines indicating the selected area (see below 2.4)
IL6R_crp.fig <-
  IL6R %>%
  ggplot(aes(x = pos.exposure/1000, y=-log10(pval.exposure))) +
  geom_point()+
  geom_hline(yintercept=8, linetype="dashed")+
  geom_vline(xintercept=154.25e3, linetype="dashed") +
  geom_vline(xintercept=154.75e3, linetype="dashed") +
  ggtitle("GWAS of CRP") +
  ylab("-log10(p)") +
  xlab(NULL)

IL6R_T1D.fig <-
  IL6R %>%
  ggplot()+
  geom_point(mapping=aes(x = pos.exposure/1000, y=-log10(pval.outcome))) +
  geom_hline(yintercept=8, linetype="dashed")+
  geom_vline(xintercept=154.25e3, linetype="dashed") +
  geom_vline(xintercept=154.75e3, linetype="dashed") +
  ggtitle("GWAS of risk of T1D") +
  ylab("-log10(p)") +
  xlab("position(kbp)")

#Obtain range for figure of gene
layer_scales(IL6R_T1D.fig)$x$range$range

IL6R_gene.fig <-
  ggplot(data = IL6R) +
  geom_blank() +
  geom_segment(x=154377.669, xend=154441.926, y=1, yend=1, linewidth = 2) +
  annotate("text", label = "IL6R",
           x= (154377.669 + 154441.926) / 2, y=1, hjust = 0.5, vjust = -1) +
  xlim(153377.7, 155441.1) +
  ylim(0.75, 2) +
  ylab(NULL) + xlab(NULL) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())


fig_IL6R_manhattan <- ggarrange(IL6R_gene.fig, IL6R_crp.fig, IL6R_T1D.fig,
                                 heights = c(1, 3, 3), nrow = 3,
                                 ncol = 1, align = "hv")

fig_IL6R_manhattan
# ggsave("figures/IL6R-manhattan-combined-fig.pdf",
#        height = 6, width = 8, units = "in")
```

## Coloc assuming 1 colocalizing variant
```{r}
#select the area containing significant SNPs
IL6R <- IL6R %>%
  filter(pos.exposure > 154.25e6 & pos.exposure < 154.75e6)


IL6R <- IL6R %>%
  mutate(maf.exposure = ifelse(eaf.exposure < 0.5, eaf.exposure, 1-eaf.exposure)) %>%
  mutate(maf.outcome  = ifelse(eaf.outcome  < 0.5, eaf.outcome,  1-eaf.outcome))

IL6R <- IL6R %>%
  filter(!is.na(beta.exposure) & !is.na(maf.outcome))


colnames(IL6R)

D1 <- list(
  type = "quant", # quantitative trait
  Beta = IL6R$beta.exposure,
  varBeta = IL6R$se.exposure^2,
  pvalues = IL6R$pval.exposure, #What is this _origin_?
  N = IL6R$samplesize.exposure,
  MAF = IL6R$maf.outcome,
  pos = IL6R$pos.exposure,
  snp = IL6R$SNP,
  sdY = 1)

D2 <- list(
  type = "cc", # case-control trait
  Beta = IL6R$beta.outcome,
  varBeta = IL6R$se.outcome,
  pvalues = IL6R$pval.outcome, #why _origin_?
  N = 18942+501638, # Case-control study (Chiou et al. 2021 Nature)
  s = 18942/(18942+501638), # N_case/(N_case+ N_ctrl)
  MAF = IL6R$maf.outcome,  #prot used here in purpose
  pos = IL6R$pos.outcome,
  snp = IL6R$SNP)

check_dataset(D1)
check_dataset(D2)

coloc_IL6R <- coloc.abf(D1, D2, p1 = 1e-4, p2 = 1e-4, p12 = 1e-5)
sensitivity(coloc_IL6R, "H4 > 0.1")

```

## SusiE

### Get LD matrix
```{r}

# ldmat_IL6R <- ld_matrix_local(
#     IL6R$SNP,
#     plink_bin = genetics.binaRies::get_plink_binary(),
#     bfile = "C:/Users/jajoko/Documents/MR Projects/plinkref/EUR")
# 
# save(ldmat_IL6R, file = "data/IL6R_crp_LDmat-2023-04-25.RData")
load(file = "data/IL6R_crp_LDmat-2023-04-25.RData")

str(ldmat_IL6R)
```


### Harmonize correlation matrix

Change data from correlation matrix to pairwise correlation format
```{r}
#Data is changed to data.table so dtplyr can be used for better perfomance
ldmat_IL6R <- cbind(rownames(ldmat_IL6R), ldmat_IL6R) %>%
  as.data.table() %>%
  pivot_longer(names_to = "variant2",
               values_to = "r2",
               cols = !matches("V1")) %>%
  rename("variant1" = "V1") %>%
  mutate(r2 = as.numeric(r2))
```

Identify effect orientation and remove effect orientation from variant names
```{r}

#Extract SNPs and get rid of duplicates
ldmat_IL6R_snps <- ldmat_IL6R %>%
  as_tibble() %>%
  select(variant1) %>%
  filter(duplicated(variant1) == FALSE)

#Extract EA and NEA
ldmat_IL6R_snps <- ldmat_IL6R_snps %>%
  mutate(EA_ld  = word(variant1, 2, sep = fixed('_'))) %>%
  mutate(NEA_ld  = word(variant1, 3, sep = fixed('_'))) %>%
  mutate(rsid = word(variant1, 1, sep=fixed('_')))
```

Correct the orientation of effect alleles in IL6R data frame
```{r}
#remove SNPs from original (IL6R) data that are not included in LD
#correlation matrix
IL6R <- IL6R %>%
  filter(SNP %in% ldmat_IL6R_snps$rsid)

#join SNP alignment data from the LD matrix to original (IL6R) data
#which includes betas and alignment data for the risk of T1D and protein
#levels
IL6R <- IL6R %>%
  full_join(ldmat_IL6R_snps, by = c("SNP" = "rsid"))

#Look if there are unlikely cases
#variants that have different effect allele to ref allele combination
IL6R %>% filter(EA_ld != effect_allele.exposure &
                   NEA_ld != other_allele.exposure) #no
IL6R %>% filter(NEA_ld != other_allele.exposure &
                   EA_ld != effect_allele.exposure) #no

#If no, harmonize the alignment of Betas with correlations coefficients in LD correlation matrix
IL6R <- IL6R %>%
  mutate(harmonized = ifelse(EA_ld != effect_allele.exposure |
                               EA_ld != effect_allele.outcome, 1, 0))
IL6R %>% filter(harmonized == 1) #0

```

No variants were harmonized. Remove variants that are not found in IL6R data frame

```{r}

#Change to data.table for better performance in following tasks
ldmat_IL6R <- ldmat_IL6R %>% as.data.table()

#Remove orientation from rsids (this time using data.table because of computational reasons)
ldmat_IL6R <- ldmat_IL6R[,rsid1 := gsub('_[ATGC]*_[ATGC]*','',variant1)]
ldmat_IL6R <- ldmat_IL6R[,rsid2 := gsub('_[ATGC]*_[ATGC]*','',variant2)]

## Proof that the approach above works (i.e. there are no characters
## in rsids)
# ldmat_IL6R_unique <- unique(ldmat_IL6R, by = "rsid1")
# ldmat_IL6R_unique <- ldmat_IL6R_unique[,rsid1 := gsub('rs','',rsid1)]
# ldmat_IL6R_unique <- ldmat_IL6R_unique[,rsid1 := as.numeric(rsid1)]
# ldmat_IL6R_unique[is.numeric(rsid1) == FALSE,]
# rm(ldmat_IL6R_unique)

#Remove variants that are not found in IL6R data frame
ldmat_IL6R <- ldmat_IL6R[rsid1 %in% IL6R$SNP |
                             rsid2 %in% IL6R$SNP]
length(unique(ldmat_IL6R$rsid1)) #1460, the correct #

```


Format the pairwise LD matrix back to LD correlation matrix form
```{r}
ldmat_IL6R_corr <- ldmat_IL6R  %>%
  as_tibble() %>%
  select(-variant1, -variant2) %>%
  pivot_wider(names_from = "rsid2", values_from = "r2")

#test for missing
ldmat_IL6R_corr %>% anyNA() #none

dim(ldmat_IL6R)
```

Format LD-matrix
```{r}
rownames <- ldmat_IL6R_corr$rsid1
ldmat_IL6R_corr <- ldmat_IL6R_corr %>%
  select(-rsid1)

ldmat_IL6R_corr <- ldmat_IL6R_corr %>%
  as.matrix()

dimnames(ldmat_IL6R_corr)[1] <- list(rownames)
```

### Prepare coloc data & run coloc.susie

```{r}
D3 <- list(
  type = "quant", # quantitative trait
  beta = IL6R$beta.exposure,
  varbeta = IL6R$se.exposure^2,
  pvalues = IL6R$pval.exposure,
  n = IL6R$samplesize.exposure,
  MAF = IL6R$maf.outcome,
  position = IL6R$pos.exposure,
  snp = IL6R$SNP,
  LD = ldmat_IL6R_corr,
  sdY = 1)

D4 <- list(
  type = "cc", # case-control trait
  beta = IL6R$beta.outcome,
  varbeta = IL6R$se.outcome^2,
  pvalues = IL6R$pval.outcome,
  n = 18942+501638, # Case-control study (Chiou et al. 2021 Nature)
  s = 18942/(18942+501638), # N_case/(N_case+ N_ctrl)
  MAF = IL6R$maf.outcome,
  LD = ldmat_IL6R_corr,
  position = IL6R$pos.outcome,
  snp = IL6R$SNP)

check_dataset(D3, req = c("beta", "varbeta", "LD", "snp"))
check_dataset(D4, req = c("beta", "varbeta", "LD", "snp"))

check_alignment(D3)
check_alignment(D4)

```


### Run coloc.susie
```{r}
S3 <- runsusie(D3, n = IL6R$samplesize.exposure[1])
S4 <- runsusie(D4, n = 18942+501638)

summary(S3)
summary(S4)

if(requireNamespace("susieR",quietly=TRUE)) {
  susie.res=coloc.susie(S3,S4)
  print(susie.res$summary)
}

if(requireNamespace("susieR",quietly=TRUE)) {
  sensitivity(susie.res,"H4 > 0.7",row=1,dataset1=D3,dataset2=D4)
  sensitivity(susie.res,"H4 > 0.7",row=2,dataset1=D3,dataset2=D4)
  sensitivity(susie.res,"H4 > 0.7",row=3,dataset1=D3,dataset2=D4)
  sensitivity(susie.res,"H4 > 0.7",row=4,dataset1=D3,dataset2=D4)
}

susie.res

```


## MR


### Import GWAS of protein and T1D risk
```{r}

#Import data

IL6R_clumped <- clump_data(IL6R)
MR_IL6R_res <- TwoSampleMR::mr(IL6R_clumped)

MR_IL6R_res_scatter <- mr_scatter_plot(MR_IL6R_res, IL6R_clumped)
MR_IL6R_res_single <- mr_singlesnp(IL6R_clumped)
MR_IL6R_res_forest <- mr_forest_plot(MR_IL6R_res_single)

MR_IL6R_res
MR_IL6R_res_scatter
MR_IL6R_res_single
MR_IL6R_res_forest

exp(MR_IL6R_res[3,]$b)
exp(MR_IL6R_res[3,]$b - 1.96*MR_IL6R_res[3,]$se)
exp(MR_IL6R_res[3,]$b + 1.96*MR_IL6R_res[3,]$se)


exp(MR_IL6R_res_single[3,]$b)
exp(MR_IL6R_res_single[3,]$b - MR_IL6R_res_single[3,]$se)
exp(MR_IL6R_res_single[3,]$b + 1.96*MR_IL6R_res_single[3,]$se)

```


